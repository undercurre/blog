---
title: 小程序模板
date: 2023-01-05 19:57:24
tags:
---

# 小程序模板构建

## 使用 npm

替换 project.config.json

```json
// 在setting中添加
    "packNpmManually": true,

    "packNpmRelationList": [

      {
        "packageJsonPath": "./package.json",

        "miniprogramNpmDistDir": "miniprogram/"
      }
    ],
```

在开发者工具右侧**详情**中勾选**使用 npm 模块**
最后在开发者工具**工具栏**选取**构建 npm**

## 组件库使用 vant-weapp

```
pnpm i @vant/weapp -S --production
```

```wxss
// 在app.wxss中添加
@import "./miniprogram_npm//@vant/weapp/common/index.wxss";
```

**使用的时候要在 json 中添加配置（todo: 暂时没有 unplugin 插件，之后自己搞一个试一下）**

```
"usingComponents": {
  "van-button": "/miniprogram_npm/@vant/weapp/button/index"
}
```

## .gitignore

新建.gitignore 文件

```
miniprogram/miniprogram_npm/*
node_modules/*
```

## miniprogram-computed

提供给你向 vue 一样的 computed 计算属性和 watch 监听器

**这个包有两个依赖**

```
pnpm install --save miniprogram-computed
pnpm install rfdc --save
pnpm install fast-deep-equal
```

```ts
import { ComponentWithComputed } from "miniprogram-computed";

ComponentWithComputed({
  data: {
    a: 1,
    b: 1,
    c: 1,
    sum: 2,
  },
  watch: {
    "a, b": function (a, b) {
      this.setData({
        c: a + b,
      });
    },
  },
  computed: {
    sum(data) {
      // 注意： computed 函数中不能访问 this ，只有 data 对象可供访问
      // 这个函数的返回值会被设置到 this.data.sum 字段中
      return data.a + data.b + data.c; // data.c 为自定义 behavior 数据段
    },
  },
  methods: {
    onTapa() {
      this.setData({
        a: this.data.a + 1,
      });
    },
    onTapb() {
      this.setData({
        b: this.data.b + 2,
      });
    },
  },
});
```

## 官方专用全局状态管理机 mobx

```
pnpm install --save mobx-miniprogram mobx-miniprogram-bindings
```

```ts
// store/index.ts
import { configure } from "mobx-miniprogram";
export { test } from "./test";

// mobx配置
// 在严格模式下，不允许在 action 外更改任何状态。
configure({ enforceActions: "observed" });
```

```ts
// store/test.ts
import { observable, runInAction } from "mobx-miniprogram";

export const test = observable({
  numA: 1000,
  numB: 1000,

  get sum() {
    return this.numA + this.numB;
  },

  double_data: function () {
    runInAction(() => {
      this.numA = this.numA * 2;
      this.numB = this.numB * 2;
    });
  },
});
```

```ts
// component
import { ComponentWithStore } from "mobx-miniprogram-bindings";
import { test } from "../../store/index";

ComponentWithStore({
  properties: {
    title: {
      type: String,
      value: "",
    },
  },
  options: {
    styleIsolation: "shared",
  },
  data: {
    someData: "...",
  },
  storeBindings: {
    store: test,
    fields: ["numA", "numB", "sum"],
    actions: {
      buttonTap: "double_data",
    },
  },
});
```

## 原子化 css

```
pnpm -D unocss unocss-preset-weapp
```

```json
// package.json
"unocss": "unocss miniprogram/**/*.wxml -c unocss.config.js --watch -o miniprogram/unocss.wxss",
"unocss:build": "unocss miniprogram/**/*.wxml -c unocss.config.js -o  miniprogram/unocss.wxss"
```

```js
// unocss.config.js

import { defineConfig } from "unocss";
import presetWeapp from "unocss-preset-weapp";
export default defineConfig({
  include: [/\.wxml$/],
  presets: [presetWeapp()],
});
```

## 国际化——miniprogram-i18n

```
pnpm i -D gulp @miniprogram-i18n/gulp-i18n-locales @miniprogram-i18n/gulp-i18n-wxml
```

在小程序源码中 pnpm init 新建 package.json 并

```
pnpm i -S @miniprogram-i18n/core
```

在项目根目录新建 gulpfile.js，并编写构建脚本

```js
const { src, dest, series } = require("gulp");
const gulpI18nWxml = require("@miniprogram-i18n/gulp-i18n-wxml");
const gulpI18nLocales = require("@miniprogram-i18n/gulp-i18n-locales");

function mergeAndGenerateLocales() {
  return src("miniprogram/i18n/*.json")
    .pipe(gulpI18nLocales({ defaultLocale: "zh-CN", fallbackLocale: "zh-CN" }))
    .pipe(dest("miniprogram/i18n/"));
}

function transpileWxml() {
  return src("miniprogram/**/*.wxml")
    .pipe(
      gulpI18nWxml({
        wxsPath: "miniprogram/i18n/locales.wxs",
      })
    )
    .pipe(dest("dist/"));
}

function copyToDist() {
  return src([
    "miniprogram/**/*",
    "!miniprogram/**/*.wxml",
    "!miniprogram/i18n/*.json",
  ]).pipe(dest("dist/"));
}

exports.default = series(copyToDist, transpileWxml, mergeAndGenerateLocales);
```

添加包命令并执行 pnpm build

```js
// 根目录package.js
    "scripts": {
        "build": "gulp"
    },
```

修改模拟器映射 project.config.json

```json
 "miniprogramRoot": "dist/"
 "packNpmRelationList": [
            {
                "packageJsonPath": "./miniprogram/package.json",
                "miniprogramNpmDistDir": "dist/"
            }
        ]
```
